<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8"/>
    <title>My Community</title>
    <script type="text/javascript" src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
    <script type="text/javascript" src="http://d3js.org/topojson.v1.min.js" charset="utf-8"></script>
    <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js" charset="utf-8"></script>
    <script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAdMu7yxgGE_OGV8wzfAGPs3XmP-5NlMGc&sensor=true" charset="utf-8"></script>
    <script type="text/javascript">
      /** Converts numeric degrees to radians */
      if (typeof(Number.prototype.toRad) === "undefined") {
        Number.prototype.toRad = function() {
          return this * Math.PI / 180;
        }
      }
    </script>
    <script type="text/javascript">
      $(function() {

        var dataLayer = d3.select("#dataLayer");
        var $form = $("#form");
        var $main = $("#main");
        var $addressInput = $form.find("input[name='address']");
        var geocoder = new google.maps.Geocoder();
        var allData = [];
        // Default location is Adelaide.
        var location = {
          latitude: -34.92862119999999,
          longitude: 138.5999594
        };

        var distanceBetweenLocations = function(location1, location2) {
          var lat1 = Number(location1.latitude);
          var lat2 = Number(location2.latitude);
          var long1 = Number(location1.longitude);
          var long2 = Number(location2.longitude);
          var R = 6371; // km
          var dLat = (lat2-lat1).toRad();
          var dLon = (long2-long1).toRad();
          var a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                  Math.cos(lat1.toRad()) * Math.cos(lat2.toRad()) *
                  Math.sin(dLon/2) * Math.sin(dLon/2);
          var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
          var d = R * c;
          return d;
        };

        var update = function() {
          $main.empty();
          $main.prepend('<p>Your location: '+location.latitude+','+location.longitude+'</p>');
          // TODO: D3 here.
          dataLayer.selectAll("circle")
            .data(allData)
            .enter()
            .append("circle")
            .attr({
              cx: function(d) {
                var distance = distanceBetweenLocations(location, d);
                return 480+distance*20;
              },
              cy: 360,
              fill: "red",
              r: 10
            });
          $.each(allData, function(index,datum) {
            var distance = distanceBetweenLocations(location, datum);
            $main.append('<p>'+datum.type+','+datum.latitude+','+datum.longitude+','+distance+'</p>');
          });
        };

        d3.csv("data/example.csv", function(error, data) {
          allData = allData.concat(data);
          update();
        });

        $form.on("submit", function(event) {

          geocoder.geocode({ address: $addressInput.val() }, function(results, status) {
            if (status == google.maps.GeocoderStatus.OK) {
              if (results[0] && results[0].geometry && results[0].geometry.location) {
                location = {
                  latitude: results[0].geometry.location.jb,
                  longitude: results[0].geometry.location.kb
                };
                update();
              }
            } else {
              alert("Geocoder failed due to: " + status);
            }
          });

          event.preventDefault();
        });

      });

    </script>
  </head>
  <body>
    <form id="form">
      <input type="text" name="address"/>
      <input type="submit" value="Go"/>
    </form>
    <div id="main"></div>
    <svg width="960" height="720">
      <g id="backgroundLayer">
        <circle cx="480" cy="360" fill="black" r="10"/>
        <circle cx="480" cy="360" fill="none" stroke="black" r="100"/>
        <circle cx="480" cy="360" fill="none" stroke="black" r="200"/>
      </g>
      <g id="dataLayer"/>
    </svg>
  </body>
</html>
